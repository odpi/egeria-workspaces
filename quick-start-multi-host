#!/usr/bin/env bash
set -euo pipefail

# Always run from repo root (this script lives at repo root)
cd "$(dirname "$0")"

echo "[quick-start-multi-host] Preparing environment (.env) and compose files..."

# Copy the server configurations to the runtime volume
echo "[quick-start-multi-host] Copying server configurations to runtime-volumes/egeria-platform-data/data/servers..."
mkdir -p runtime-volumes/egeria-platform-data/data
cp -r compose-configs/egeria-quickstart/servers runtime-volumes/egeria-platform-data/data/

pushd compose-configs/egeria-quickstart >/dev/null
  # Generate/update .env and normalize exchange/config/config.json
  ./gen-env.sh

  echo "[quick-start-multi-host] Ensuring docker network 'egeria_network' exists..."
  if ! docker network inspect egeria_network >/dev/null 2>&1; then
    docker network create egeria_network >/dev/null
    echo "[quick-start-multi-host] Created docker network 'egeria_network'"
  else
    echo "[quick-start-multi-host] Docker network 'egeria_network' already exists"
  fi

  echo "[quick-start-multi-host] Starting quickstart stack with external Kafka listeners..."
  docker compose \
    -f egeria-quickstart.yaml \
    -f egeria-quickstart-cluster.yaml \
    up -d
popd >/dev/null
echo "[quick-start-multi-host] Done. Useful notes:"
HOST_FQDN_PRINT=$(grep '^HOST_FQDN=' compose-configs/egeria-quickstart/.env | cut -d= -f2- || echo "localhost")
KAFKA_CLUSTER_ID_PRINT=$(grep '^KAFKA_CLUSTER_ID=' compose-configs/egeria-quickstart/.env | cut -d= -f2- || echo "42")
echo "  - Effective HOST_FQDN: ${HOST_FQDN_PRINT}"
echo "  - Effective KAFKA_CLUSTER_ID: ${KAFKA_CLUSTER_ID_PRINT}"
echo "  - Egeria (platform): https://${HOST_FQDN_PRINT:-localhost}:9443 (reachable from other hosts if DNS resolves)"
echo "  - Kafka external:    ${HOST_FQDN_PRINT:-localhost}:9194"
  echo "  - Jupyter (local):   http://localhost:7888   (password: egeria)"
  echo "  - Web (local):       http://localhost:8085"
